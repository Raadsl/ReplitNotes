<!--Made by @Raadsel-->
<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>SnippetVault</title>
  <link href="/style.css" rel="stylesheet" type="text/css" />
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://unpkg.com/@replit/extensions@1.7.2/dist/index.global.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.6.0/styles/default.min.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" crossorigin="anonymous">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.6.0/highlight.min.js"></script>
  <script type='module'>
    try {
      let firstTheme = true
      await replit.init({permissions: []})
      async function setTheme() {
        await replit.themes.getCurrentTheme().then(theme => {
          for (const value in theme.values.global) {
            if (!value.startsWith('_')) {
              const cssVariableName = '--' + value.replace(/[A-Z]/g, letter => `-${letter.toLowerCase()}`)
              document.documentElement.style.setProperty(cssVariableName, theme.values.global[value])
            }
          }
        })
        if (!firstTheme) {
          await replit.messages.showNotice("Theme updated successfully for SnippetVault", 2000)
        }
        firstTheme = false
      }
      await setTheme()
      await replit.themes.onThemeChange(setTheme)

    } catch (err) {
      await replit.debug.error("Error with setting theme.", err);
      //document.body.innerHTML = "Not opened as extension"
    }

    let file = await replit.session.getActiveFile()
    let fileExt = null
    async function getUserSlug() {
      const currentUser = await replit.data.currentUser();
      const currentRepl = await replit.data.currentRepl();
      $("#slughere").text(currentRepl.repl.slug)
      return `${currentUser.user.username}/${currentRepl.repl.slug}`;
    }
    async function getUser() {
      const currentUser = await replit.data.currentUser();
      return `${currentUser.user.username}`;
    }
    (async () => {

      function updateSnippets() {
        displaySnippets();
        //repeat
      }

      function generateUniqueId() {
        return Date.now().toString(36) + Math.random().toString(36).substr(2, 5);
      }

      function generateSnippetId() {
        return Date.now().toString(36) + Math.random().toString(36).substr(2, 5);
      }

      const user_slug = await getUserSlug();
      const user = await getUser();

      let firstime = true

      function handleNoteTextRightClick(event, noteText) {
        event.preventDefault();
        const contextMenu = document.getElementById("context-menu");
        contextMenu.style.display = "block";
        contextMenu.style.left = event.pageX + "px";
        contextMenu.style.top = event.pageY + "px";
        contextMenu.style.zIndex = 1000;
        contextMenu.querySelector("#edit-note").onclick = () => {
          editNote(noteText);
          contextMenu.style.display = "none";
        };
        document.addEventListener("click", () => {
          contextMenu.style.display = "none";
        });
      }

      function editNote(noteText) {
        const noteId = noteText.data("id");
        const currentText = noteText.text();
        const newText = prompt("Edit note:", currentText);
        if (newText && newText !== currentText) {
          const notes = JSON.parse(localStorage.getItem("notes") || "[]");
          const noteIndex = notes.findIndex((note) => note.id === noteId);
          if (noteIndex > -1) {
            notes[noteIndex].note = newText;
            localStorage.setItem("notes", JSON.stringify(notes));
            updateNotes();
          }
        }
      }

      // snippets  //
      function handleSnippetTitleRightClick(event, snippetTitle) {
        event.preventDefault();
        const contextMenu = document.getElementById("context-menu");
        contextMenu.style.display = "block";
        contextMenu.style.left = event.pageX + "px";
        contextMenu.style.top = event.pageY + "px";
        contextMenu.style.zIndex = 1000;
        contextMenu.querySelector("#edit-note").onclick = () => {
          editSnippet(snippetTitle);
          contextMenu.style.display = "none";
        };
        document.addEventListener("click", () => {
          contextMenu.style.display = "none";
        });
      }

      function handleSnippetCodeRightClick(event, snippetCode) {
        event.preventDefault();
        const contextMenu = document.getElementById("context-menu");
        contextMenu.style.display = "block";
        contextMenu.style.left = event.pageX + "px";
        contextMenu.style.top = event.pageY + "px";
        contextMenu.style.zIndex = 1000;
        contextMenu.querySelector("#edit-note").onclick = () => {
          editSnippetContent(snippetCode);
          contextMenu.style.display = "none";
        };
        document.addEventListener("click", () => {
          contextMenu.style.display = "none";
        });
      }

      function editSnippet(snippetTitle) {
        const snippetId = snippetTitle.data("id");
        const currentTitle = snippetTitle.text();
        const newTitle = prompt("Edit snippet title:", currentTitle);
        if (newTitle && newTitle !== currentTitle) {
          const snippets = JSON.parse(localStorage.getItem("snippets") || "[]");
          const snippetIndex = snippets.findIndex((snippet) => snippet.id === snippetId);
          if (snippetIndex > -1) {
            snippets[snippetIndex].title = newTitle;
            localStorage.setItem("snippets", JSON.stringify(snippets));
            displaySnippets();
          }
        }
      }

      function editSnippetContent(snippetCode) {
        const snippetId = snippetCode.data("id");
        const currentCode = snippetCode.text();
        const currentLanguage = snippetCode.data("language");

        // Show the modal
        const editSnippetModal = $("#edit-snippet-modal");
        editSnippetModal.removeClass("hidden");

        // Set the current code in the textarea
        const editSnippetTextarea = $("#edit-snippet-textarea");
        editSnippetTextarea.val(currentCode);

        // Set the current language in the dropdown list
        const editSnippetLanguage = $("#edit-snippet-language");
        editSnippetLanguage.val(currentLanguage);

        // Remove previous event handlers
        $("#edit-snippet-save-btn").off("click");
        $("#edit-snippet-cancel-btn").off("click");

        // Handle save button click
        $("#edit-snippet-save-btn").on("click", function () {
          const newCode = editSnippetTextarea.val();
          const newLanguage = editSnippetLanguage.val() === 'current' ? currentLanguage : editSnippetLanguage.val();
          if (newCode && newCode !== currentCode || newLanguage != currentLanguage) {
            const snippets = JSON.parse(localStorage.getItem("snippets") || "[]");
            const snippetIndex = snippets.findIndex((snippet) => snippet.id === snippetId);
            if (snippetIndex > -1) {
              snippets[snippetIndex].code = newCode;
              snippets[snippetIndex].language = newLanguage;

              localStorage.setItem("snippets", JSON.stringify(snippets));
              displaySnippets();
            }
          }
          // Hide the modal
          editSnippetModal.addClass("hidden");
        });

        // Handle cancel button click
        $("#edit-snippet-cancel-btn").on("click", function () {
          // Hide the modal
          editSnippetModal.addClass("hidden");
        });
      }
      function mapFileExtensionToLanguage(fileExt) {
        const extensionToLanguageMap = {
          "jsx": "javascript",
          "tsx": "javascript",
          "cjs": "javascript",
          "ts": "javascript",
          'js': 'javascript',
          'py': 'python',
          'java': 'java',
          'cpp': 'cpp',
          'c': 'c',
          'cs': 'csharp',
          'html': 'xml', //it doesnt detect html for some reason
          'css': 'css',
          'xml': 'xml',
          "json": "swift",//also doesnt have json
          "swift": "swift",
          "md": "txt",
          "svg": "xml"
          //!TODO add more
        };
        return extensionToLanguageMap[fileExt] || 'txt';
      }
      $("#snippet-form").submit(function (event) {
        event.preventDefault();
        const title = $("#snippet-title").val();
        const code = $("#snippet-code").val();
        const detectedLanguageResult = hljs.highlightAuto(code);
        const detectedLanguage = detectedLanguageResult.language || 'txt';
        $("#snippet-title").val("");
        $("#snippet-code").val("");
        const snippets = JSON.parse(localStorage.getItem("snippets") || "[]");
        snippets.push({user_slug, title, code, language: detectedLanguage, id: generateSnippetId()});
        localStorage.setItem("snippets", JSON.stringify(snippets));
        displaySnippets();
      });
      $("#snippets-list").on("click", ".delete-snippet", function () {
        const snippetId = $(this).data("id");
        if (confirm("Are you sure you want to delete this snippet? This cannot be undone.")) {
          const snippets = JSON.parse(localStorage.getItem("snippets") || "[]");
          const filteredSnippets = snippets.filter((snippet) => snippet.id !== snippetId);
          localStorage.setItem("snippets", JSON.stringify(filteredSnippets));
          displaySnippets();
        }
      });

      function displaySnippets() {
        function highlightCodeSnippets() {
          document.querySelectorAll("pre.hljs").forEach((block) => {
            hljs.highlightElement(block);
          });
        }
        const snippets = JSON.parse(localStorage.getItem("snippets") || "[]");
        const snippetsList = $("#snippets-list");
        snippetsList.empty();

        // Sort snippets based on their properties
        snippets.sort((a, b) => {
          if (a.pinned && !b.pinned) return -1;
          if (!a.pinned && b.pinned) return 1;
          if (a.last_copied && !b.last_copied) return -1;
          if (!a.last_copied && b.last_copied) return 1;
          if (a.last_copied > b.last_copied) return -1;
          if (a.last_copied < b.last_copied) return 1;
          return 0;
        });

        snippets.forEach(function (snippet) {
          const listItem = $('<li></li>');
          const snippetTitle = $('<span class="snippet-title" data-id="' + snippet.id + '"></span>');
          snippetTitle.text(snippet.title).append($('<span class="click-to-copy"> ∙ Click the code to copy it </span>'));

          const snippetCode = $('<pre class="snippet-code hljs" data-id="' + snippet.id + '" data-language="' + snippet.language + '"></pre>');

          snippetCode.text(snippet.code);
          snippetTitle.on("contextmenu", function (e) {
            e.preventDefault();
            handleSnippetTitleRightClick(e, $(this));
          });
          snippetCode.on("contextmenu", function (e) {
            e.preventDefault();
            handleSnippetCodeRightClick(e, $(this));
          });
          const snippetContentWrapper = $('<div class="snippet-content-wrapper"></div>');
          snippetContentWrapper.append(snippetTitle);
          snippetContentWrapper.append(snippetCode);
          listItem.append(snippetContentWrapper);
          listItem.append('<button class="delete-snippet align-middle" data-id="' + snippet.id + '" title="Delete"><i class="fas fa-trash-alt"></i></button>');
          listItem.append('<button class="edit-code-snippet align-middle" data-id="' + snippet.id + '" title="Edit"><i class="fas fa-pencil-alt"></i></button>');
          listItem.append('<button class="toggle-pin-snippet align-middle ' + (snippet.pinned ? 'pinned-button' : '') + '" data-id="' + snippet.id + '" title="' + (snippet.pinned ? 'Pinned - click to unpin' : 'Pin this snippet') + '">' + (snippet.pinned ? '<i class="fas fa-thumbtack pinned"></i>' : '<i class="fas fa-thumbtack"></i><i class="fas fa-times"></i>') + '</button>');
          snippetsList.append(listItem);
          highlightCodeSnippets();
          filterSnippets()
        });

      }

      $("#snippets-list").on('click', '.toggle-pin-snippet', function () {
        const snippetId = $(this).data('id');
        const snippets = JSON.parse(localStorage.getItem("snippets") || "[]");
        const snippetIndex = snippets.findIndex((snippet) => snippet.id === snippetId);
        if (snippetIndex > -1) {
          snippets[snippetIndex].pinned = !snippets[snippetIndex].pinned;
          localStorage.setItem("snippets", JSON.stringify(snippets));
          displaySnippets();
        }
      });
      $("#snippets-list").on('click', '.edit-code-snippet', function () {
        const snippetCode = $(this).closest("li").find(".snippet-code");
        editSnippetContent(snippetCode);
      });


      $("#snippets-list").on('click', '.snippet-code', function () {
        const code = $(this).text();
        const snippetId = $(this).data('id');
        navigator.clipboard.writeText(code).then(() => {
          replit.messages.showConfirm('Snippet copied', 2321);

          // Update the last_copied property for the copied snippet
          const snippets = JSON.parse(localStorage.getItem("snippets") || "[]");
          const snippetIndex = snippets.findIndex((snippet) => snippet.id === snippetId);
          if (snippetIndex > -1) {
            snippets[snippetIndex].last_copied = Date.now();
            localStorage.setItem("snippets", JSON.stringify(snippets));
            displaySnippets();
          }
        });
      });

      displaySnippets();

      async function filterSnippets() {
        file = await replit.session.getActiveFile()
        if (file !== null) {
          fileExt = file.split('.').pop();
        }
        const searchText = $("#snippet-search").val().toLowerCase();
        const filterLanguage = $("#snippet-filter-language").is(":checked");
        const notes = JSON.parse(localStorage.getItem("notes") || "{}");
        notes.filterByActiveLanguage = filterLanguage;
        localStorage.setItem("notes", JSON.stringify(notes));


        $("#snippets-list li").each(function () {
          const snippetTitle = $(this).find(".snippet-title").text().toLowerCase();
          const snippetCode = $(this).find(".snippet-code").text().toLowerCase();
          const snippetLanguage = $(this).find(".snippet-code").data("language");
          const currentlang = mapFileExtensionToLanguage(fileExt)
          const matchesSearch = snippetTitle.includes(searchText) || snippetCode.includes(searchText);
          const matchesLanguage = !filterLanguage || snippetLanguage === currentlang;

          if (matchesSearch && matchesLanguage) {
            $(this).show();
          } else {
            $(this).hide();
          }
        });
      }

      $("#snippet-search").on("input", filterSnippets);
      $("#snippet-filter-language").on("change", filterSnippets);
      replit.session.onActiveFileChange(filterSnippets)

      $("#controls-explanation-btn").on("click", function () {
        $("#instructions-modal").removeClass("hidden");
      });
      $("#instructions-modal-close-btn").on("click", function () {
        $("#instructions-modal").addClass("hidden");
      });
      $(document).on("click", function (event) {
        // Check if the click target is outside the instructions-modal-content
        if (
          !$(event.target).closest(".instructions-modal-content").length &&
          !$(event.target).is("#controls-explanation-btn")
        ) {
          $("#instructions-modal").addClass("hidden");
        }
      });
      $("#delete-all-data-btn").on("click", function () {
        if (confirm("Are you sure you want to delete all the data? This action cannot be undone.")) {
          localStorage.removeItem("notes")
          localStorage.removeItem("snippets")
          displaySnippets()
        } else {
          displaySnippets()
        }
      })

      function exportSnippets() {
        const snippets = JSON.parse(localStorage.getItem("snippets") || "[]");
        const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(snippets));
        const downloadAnchorNode = document.createElement("a");
        downloadAnchorNode.setAttribute("href", dataStr);
        downloadAnchorNode.setAttribute("download", "snippetvault_snippets.json");
        document.body.appendChild(downloadAnchorNode); // required for firefox
        downloadAnchorNode.click();
        downloadAnchorNode.remove();
      }

      async function importSnippets() {
        const fileInput = document.createElement("input");
        fileInput.type = "file";
        fileInput.accept = ".json";
        fileInput.onchange = async (event) => {
          const file = event.target.files[0];
          const fileContent = await file.text();
          try {
            const importedSnippets = JSON.parse(fileContent);
            if (Array.isArray(importedSnippets)) {
              localStorage.setItem("snippets", JSON.stringify(importedSnippets));
              displaySnippets();
              replit.messages.showNotice("Snippets imported successfully!", 2000);
            } else {
              replit.messages.showNotice("Invalid JSON file format.", 2000);
            }
          } catch (error) {
            replit.messages.showNotice("Error importing snippets: " + error.message, 4000);
          }
        };
        fileInput.click();
      }
      $("#export-snippets-btn").on("click", exportSnippets);
      $("#import-snippets-btn").on("click", importSnippets);

      const notes = JSON.parse(localStorage.getItem("notes") || "{}");
      const filterByActiveLanguage = notes.filterByActiveLanguage || false;
      $("#snippet-filter-language").prop('checked', filterByActiveLanguage);
    })();
  </script>
</head>

<body>
  <div class="header-row">
    <a href='/'>
      <h1 class="main-heading" title='Made by @Raadsel'>SnippetVault</h1>
    </a>
    <div class="button-container">
      
      <button id="controls-explanation-btn" class="btn btn-sm btn-outline-secondary">Controls</button>

    </div>
  </div>
  <hr>
  <section class="content-container">
    <form id="snippet-form" class="">
      <div>
        <label for="snippet-title">Title:</label>
        <input style='width:100%' type="text" id="snippet-title" name="snippet-title" maxlength="120" required>
      </div>
      <div>
        <label for="snippet-code">Code:</label>
        <textarea title="Don't share sensitive information" name="note" style='width:100%' id="snippet-code"
          name="snippet-code" rows="4" maxlength="15000" required></textarea>
      </div>
      <div>
        <button class="btn btn-primary" type="submit" style='width:100%;'>Store Snippet</button>
      </div>
    </form>
    <div id='search-options'>
      <input type="text" id="snippet-search" placeholder="Search snippets..." />
      <label class="checkbox-container">Filter by active language
        <input id='snippet-filter-language' type="checkbox">
        <span class="checkbox-mark"></span>
      </label>
    </div>
    <hr>
    <ul id="snippets-list" class="list-container"></ul>
  </section>
  <div id="context-menu" class="context-menu">
    <ul>
      <li id="edit-note">Edit Note</li>
    </ul>
  </div>
  <div id="edit-snippet-modal" class="edit-snippet-modal hidden">
    <div class="edit-snippet-modal-content">+
      <h2>Edit Snippet Content</h2>
      <p>Works best when extension is opened with a big pane.</p>
      <textarea id="edit-snippet-textarea" rows="10" cols="50"></textarea>
      <button id="edit-snippet-save-btn">Save</button>
      <button id="edit-snippet-cancel-btn">Cancel</button>
      <select id="edit-snippet-language">
        <option value="javascript">JavaScript</option>
        <option value="python">Python</option>
        <option value="java">Java</option>
        <option value="cpp">C++</option>
        <option value="cs">C#</option>
        <option value="c">C</option>
        <option value="xml">XML/HTML</option>
        <option value="css">CSS</option>
        <option value="swift">Swift</option>
        <option value="txt">Plain Text</option>
      </select>
    </div>
  </div>
  <div id="instructions-modal" class="instructions-modal hidden">
    <div class="instructions-modal-content">
      <h2>Controls</h2>
      <ul>

        <li>Right-click on a snippet to edit, or press the edit button, to edit the title, right click the title</li>
        <li>To change the language, edit the snippet and select the right language. It gets chosen automatically, but
          sometimes, with small codes it can be wrong.</li>
        <li>Click on the code of a snippet to copy its code</li>
        <li>Press the delete buttons to delete the item, to delete all data, press this button: <button id="delete-all-data-btn" class="btn btn-sm btn-primary">Delete Snippets</button></li>
        <li>If you pin a snippet it will stay on top</li>
        <li>To import or export your snippets, press these buttons: <button id="export-snippets-btn"
            class="btn btn-sm btn-primary">Export Snippets</button>
          <button id="import-snippets-btn" class="btn btn-sm btn-primary">Import Snippets</button>
        </li>
      </ul>
      <button id="instructions-modal-close-btn">Close</button>
    </div>
  </div>
</body>
</html>